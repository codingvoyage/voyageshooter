-- Configuring the deaththread
getThreadID ourScriptID
getLinkedEntityID --> theEntityID
    eval ourScriptID + "deaththread" --> customDeathThreadIDName
newthread 41 customDeathThreadIDName
    wait 20
    callthreadfunction customDeathThreadIDName [configure] ourScriptID theEntityID

rotate 180
newvelocity 0.7

move 350

branch [Attack]

        -- Updated bullet rain, using random velocities and displacements to make
        -- this a challenging, yet reasonable rain of bullets to avoid.

        setvar done false
        while done == false

            -- Randomize the number fired and the delay between firings
            rand 3 6 --> rateoffire
            rand 150 300 --> delay

            for i = 0 and i < rateoffire

                -- BULLET SETTINGS
                -- Randomize initialDisplacement of rows, spacing, and velocity
                rand -450 350 --> initialDisplacement
                rand 75 100 --> spaceBetweenBullets
                rand 15 50 --> velocity
                setvar angle 0
                setvar distanceFromStart 20

                -- callscriptfunction 1 [shootRowNonCenteredVelocity] 0 50 rateoffire spaceBetweenBullets initialDisplacement velocity
                -- WE MODIFY SHOOT-ROWS-WITH-CUSTOM-VELOCITY-NON-CENTERED
                -- SO THAT WE CAN HAVE A BIT OF A WOBBLE!

                setvar bulletCount rateoffire
                setvar displacement spaceBetweenBullets
                setvar currentDisplacement initialDisplacement

                -- function [shootRowNonCenteredVelocity] angle distanceFromStart bulletCount displacement initialDisplacement velocity
                for j = 0 and j < bulletCount

                    -- ============================================================
                    -- --------------------BEGIN FUNCTION -------------------------
                    -- ============================================================
                    -- Magic variable 25 is BULLET_OFFSET
                    -- Magic variable 90 is ROTATION_FACTOR

                    getEntityX entityX
                    getEntityY entityY
                    getEntityAngle entityAngle

                    eval [ entityAngle - 90 ] + angle --> adjustedAngle
                    toradian adjustedAngle --> angleInRad

                    eval entityX + 25 --> entityCenterX
                    eval entityY + 25 --> entityCenterY

                    cos angleInRad --> cosVal
                    sin angleInRad --> sinVal
                    eval cosVal * distanceFromStart --> distanceOffsetX
                    eval sinVal * distanceFromStart --> distanceOffsetY

                    eval entityCenterX + distanceOffsetX --> fireX
                    eval entityCenterY + distanceOffsetY --> fireY
                    eval entityAngle + angle --> fireR

                    -- Now, we must transform fireX and fireY
                    -- so that it is perpendicular to the angle?

                    eval entityAngle + angle --> theAngle
                    toradian theAngle --> theAngle

                    cos theAngle --> cosAngle
                    sin theAngle --> sinAngle

                    eval currentDisplacement * cosAngle --> xStuff
                    eval currentDisplacement * sinAngle --> yStuff

                    eval fireX - xStuff --> fireX
                    eval fireY - yStuff --> fireY

                    -- Now the wobble depends on how much we mess with fireR
                    rand 0.5 8.5 --> wobbleFactor
                    rand 0 1 --> posNeg
                    if posNeg == 0
                        -- Negative
                        eval wobbleFactor * -1 --> wobbleFactor
                    endif
                    eval fireR + wobbleFactor --> fireR

                    spawnBulletAtVelocity fireX fireY fireR velocity
                    -- ============================================================
                    -- ----------------------END FUNCTION -------------------------
                    -- ============================================================

                    eval currentDisplacement + displacement --> currentDisplacement
                next j + 1 --> j

            next i + 1 --> i

            wait delay
        wend

        wait 300

goto [Attack]

wait 500
orbit 90 80 0
wait 50

print rotationamount

for i = 0 and i < bulletthing
    fire i 20
next i + 1 --> i

rotate rotationamount


function [otherway]
    setThreadVariable rotationamount -15
    -- print rotationamount
return


-- as it gets lower, bullets are more frequent
var shootingFrequency 60

label [loop]

for angle = 0 and angle < 360
    fire angle 50
next angle + shootingFrequency --> angle


wait 90
rotate 10

if shootingFrequency > 5
    eval shootingFrequency - 0.1 --> shootingFrequency
endif
goto [loop]

