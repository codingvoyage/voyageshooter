-- This is the boss of Stage one. I like Touhou's bullet hell and all, but I am
-- also fond of the wanton. recklessness of FPSs. This boss will be reckless.
    -- Sweep in from the side of the screen
    -- First of all, the boss is spawned at (-200, -200)
    -- We want it to move to the center of the screen, close to the top


var state 0

-- Create the auxiliary threads
newthread 39 "weaponthread"
newthread 40 "movementthread"
newthread 41 "deaththread"

-- Give the program a moment to register the new threads...
wait 20

-- Pass the auxiliary threads the ID of this thread
getThreadID ourID
callthreadfunction "weaponthread" [giveMainHandle] ourID
callthreadfunction "movementthread" [giveMainHandle] ourID

-- Configuring the deaththread for two auxiliary threads
callthreadfunction "deaththread" [configure2] ourID "boss" "weaponthread" "movementthread"

-- Execute the initial entrance sequence.
var complete false
while complete != true
    wait 50
    callthreadfunction "movementthread" [isInitialEntranceDone] --> complete
wend

print "DONE WITH ENTRANCE SEQUENCE"

-- The battle begins.
-- Switch between normal shooting attacks and the charging attack
-- Once HP drops below a critical point, execute the desperation move.

var desperation false
var alternate 0

while desperation != true
    if alternate == 0
        -- CHARGE ATTACK
        setvar state 1
        wait 15000
        setvar alternate 1

        goto [CONTINUE]
    endif


    if alternate == 1
        -- At this point, we also want to make life more complicated by spawning two
        -- other enemies to harass the player! BULLET SPAM TEAM LET'S GO!
        setvar state 2

        isThereEntity "m1" --> resultbool
        if resultbool != true
            spawn "Minion" "m1" 150 -300
        endif

        isThereEntity "m2" --> resultbool
        if resultbool != true
            spawn "Minion" "m2" 750 -300
        endif

        wait 8000
        setvar alternate 0
        goto [CONTINUE]
    endif

    label [CONTINUE]

    -- If health is below 200, go to desperation mode
    getEntityHP "boss" --> hp
    if hp < 300
        print "DESPERATION MOVE GO!"
        setvar desperation true
    endif
wend

-- Desperate last attack

setvar state 3

label [WAITTODIE]
    wait 500
goto [WAITTODIE]

endthread



function [getCurrentState]
return state

function [makeDesperate]
    setvar desperation true
return


label [donothing]

    wait 250

    faceplayer

    for count = 0 and count < 5
        callscriptfunction 1 [shoot]
        wait 50
    next count + 1 --> count

goto [donothing]
