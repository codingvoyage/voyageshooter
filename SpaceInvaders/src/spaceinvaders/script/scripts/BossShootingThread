var mainhandle
var ENTITYID "boss"

-- Needed for loading purposes.
wait 50

-- Give this Thread a reference to the Entity
getThreadID ourID
bindthreadtomarionette ourID ENTITYID


label [LOOP]


    -- Get the current State from the mainhandle, so it's like asking
    -- mission control or the brain for the latest news.
    callthreadfunction mainhandle [getCurrentState] --> currentState


    -- ====================
    -- When body slamming the player, shoot him too!
    -- ====================
    if currentState == 1

        -- Shoot 10 bursts of bullets
        for count = 0 and count < 20

            -- Each burst of bullets...
            for i = 0 and i < 360

                -- We wait to give the bullets a bit of time to emerge
                fire i 20
                wait 20

                -- Add some randomness to the shooting time.
                rand 10 50 --> shootingvariation

            next i + shootingvariation --> i

            -- If currentState had changed, we want to stop shooting ASAP
            goto [ABORT_SHOOTING]

            -- wait 30
        next count + 1 --> count

    endif
    label [ABORT_SHOOTING]

    -- ====================
    -- Shoot bullets around in a circle
    -- ====================
    if currentState == 2
        print "!!!"

        for angle = 0 and angle < 360

            eval angle + 1 --> angle2
            eval angle2 + 1 --> angle3

            fire angle 50
            fire angle2 50
            fire angle3 50

        next angle + 30 --> angle

        wait 300
    endif

    if currentState == 3
        -- Rains a curtain of bullets upon the enemy. A desperation move

        -- setrotation to 0 or something, just face down.
        -- spawn groups of bullets of random velocities... 

        setvar done false
        setvar rateoffire 5
        while done == false
            for i = 0 and i < rateoffire
                -- rand min max --> var
                rand 0 

            next
            
        wend

        wait 300
    endif

    wait 100


goto [LOOP]



function [giveMainHandle] thehandle
    setvar mainhandle thehandle
return
